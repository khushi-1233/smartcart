<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCart - Analytics</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            padding-top: 70px;
            background: var(--bg-secondary);
        }

        .page-header {
            background: var(--bg-primary);
            padding: var(--spacing-2xl) 0;
            margin-bottom: var(--spacing-2xl);
            border-bottom: 1px solid var(--gray-200);
        }

        body.dark-mode .page-header {
            border-bottom-color: var(--gray-700);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background: var(--bg-primary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
        }

        body.dark-mode .stat-card {
            border-color: var(--gray-700);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-card {
            background: var(--bg-primary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--spacing-xl);
        }

        body.dark-mode .chart-card {
            border-color: var(--gray-700);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .chart-placeholder {
            height: 300px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="home.html" class="nav-brand">
                <span class="brand-icon">ðŸ›’</span>
                <span class="brand-name">SmartCart</span>
            </a>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="inventory.html" class="nav-item">Inventory</a>
                <a href="suggestions.html" class="nav-item">AI Suggestions</a>
                <a href="profile.html" class="nav-item active">Analytics</a>
                <a href="settings.html" class="nav-item">Settings</a>
                <button class="btn btn-small" onclick="SmartCart.toggleDarkMode()">
                    <span id="theme-icon">ðŸŒ™</span>
                </button>
                <button class="btn btn-small btn-secondary" onclick="SmartCart.handleLogout()">
                    Logout
                </button>
            </div>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">ðŸ“Š Spending Analytics</h1>
            <p class="page-description">Track your grocery spending patterns and insights</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Analytics Cards -->
        <div class="analytics-grid">
            <div class="stat-card">
                <div class="stat-icon">ðŸ’°</div>
                <div class="stat-value" id="total-spent">â‚¹0</div>
                <div class="stat-label">Total Spent This Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ“ˆ</div>
                <div class="stat-value" id="avg-weekly">â‚¹0</div>
                <div class="stat-label">Average Weekly Spend</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸŽ¯</div>
                <div class="stat-value" id="budget-status">On Track</div>
                <div class="stat-label">Budget Status</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ðŸ’¾</div>
                <div class="stat-value" id="savings">â‚¹0</div>
                <div class="stat-label">Total Savings</div>
            </div>
        </div>

        <!-- Spending Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Weekly Spending Trend</h3>
                <button class="btn btn-small btn-secondary" onclick="loadAnalytics()">
                    ðŸ”„ Refresh
                </button>
            </div>
            <div class="chart-placeholder" id="spending-chart"></div>
        </div>

        <!-- Category Breakdown -->
        <div class="analytics-card">
            <h3 style="margin-bottom: 1.5rem;">Spending by Category</h3>
            <div id="category-breakdown"></div>
        </div>

        <!-- Top Items -->
        <div class="analytics-card">
            <h3 style="margin-bottom: 1.5rem;">Most Expensive Items</h3>
            <div id="top-items"></div>
        </div>
    </div>

    <script>
        // Load analytics on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await SmartCart.requireAuth();
            await loadAnalytics();
        });

        // Load analytics data
        async function loadAnalytics() {
            try {
                SmartCart.showLoading();
                const { data: { user } } = await supabase.auth.getUser();

                // Get current month start and end dates
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();

                // Load all grocery items from this month
                const { data: items, error: itemsError } = await supabase
                    .from('grocery_items')
                    .select('*')
                    .eq('user_id', user.id)
                    .gte('created_at', monthStart)
                    .lte('created_at', monthEnd);

                if (itemsError && itemsError.code !== 'PGRST116') throw itemsError;

                // Calculate total spent this month
                const totalSpent = (items || []).reduce((sum, item) => sum + parseFloat(item.price || 0), 0);

                // Calculate weekly average (divide by weeks in month)
                const weeksInMonth = Math.ceil(now.getDate() / 7);
                const avgWeekly = weeksInMonth > 0 ? totalSpent / weeksInMonth : 0;

                // Load budget
                const { data: budget } = await supabase
                    .from('budgets')
                    .select('amount')
                    .eq('user_id', user.id)
                    .maybeSingle();

                const budgetAmount = budget?.amount || 5000;
                const savings = Math.max(0, budgetAmount - totalSpent);
                const budgetStatus = totalSpent <= budgetAmount ? 'On Track âœ…' : 'Over Budget âš ï¸';

                // Update UI
                document.getElementById('total-spent').textContent = SmartCart.formatCurrency(totalSpent);
                document.getElementById('avg-weekly').textContent = SmartCart.formatCurrency(avgWeekly);
                document.getElementById('budget-status').textContent = budgetStatus;
                document.getElementById('budget-status').style.color = totalSpent <= budgetAmount ? '#10b981' : '#ef4444';
                document.getElementById('savings').textContent = SmartCart.formatCurrency(savings);

                // Create spending chart
                createSpendingChart(items || [], budgetAmount);

                // Create category breakdown
                createCategoryBreakdown(items || []);

                // Show top spending items
                showTopItems(items || []);

            } catch (error) {
                console.error('Error loading analytics:', error);
                SmartCart.showToast('Failed to load analytics', 'error');
            } finally {
                SmartCart.hideLoading();
            }
        }

        // Create spending chart
        function createSpendingChart(items, budget) {
            const chartContainer = document.getElementById('spending-chart');
            
            if (items.length === 0) {
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“Š</div>
                        <p style="color: var(--text-secondary);">No spending data yet. Start adding items to see your analytics!</p>
                    </div>
                `;
                return;
            }

            // Group items by week
            const weeks = {};
            const now = new Date();
            
            items.forEach(item => {
                const date = new Date(item.created_at);
                const weekNum = Math.ceil(date.getDate() / 7);
                const weekKey = `Week ${weekNum}`;
                
                if (!weeks[weekKey]) {
                    weeks[weekKey] = 0;
                }
                weeks[weekKey] += parseFloat(item.price || 0);
            });

            // Create bar chart
            const maxSpending = Math.max(...Object.values(weeks), budget / 4);
            const bars = Object.entries(weeks).map(([week, amount]) => {
                const percentage = (amount / maxSpending) * 100;
                const color = amount > (budget / 4) ? '#ef4444' : '#10b981';
                
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <div style="font-weight: 600; color: ${color}; font-size: 0.9rem;">
                            ${SmartCart.formatCurrency(amount)}
                        </div>
                        <div style="width: 100%; height: 200px; display: flex; align-items: flex-end; justify-content: center;">
                            <div style="width: 80%; height: ${percentage}%; background: ${color}; border-radius: 8px 8px 0 0; transition: all 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${week}</div>
                    </div>
                `;
            }).join('');

            chartContainer.innerHTML = `
                <div style="display: flex; gap: 16px; padding: 20px; align-items: flex-end;">
                    ${bars}
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200); text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    Budget per week: ${SmartCart.formatCurrency(budget / 4)} | Total Budget: ${SmartCart.formatCurrency(budget)}
                </div>
            `;
        }

        // Create category breakdown
        function createCategoryBreakdown(items) {
            const container = document.getElementById('category-breakdown');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No data available</p>';
                return;
            }

            // Group by category
            const categories = {};
            items.forEach(item => {
                const cat = item.category || 'Other';
                if (!categories[cat]) categories[cat] = 0;
                categories[cat] += parseFloat(item.price || 0);
            });

            const total = Object.values(categories).reduce((sum, amt) => sum + amt, 0);
            const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]);

            const categoryColors = {
                'Dairy': '#3b82f6',
                'Vegetables': '#10b981',
                'Fruits': '#f59e0b',
                'Meat': '#ef4444',
                'Grains': '#8b5cf6',
                'Snacks': '#ec4899',
                'Beverages': '#06b6d4',
                'Other': '#6b7280'
            };

            container.innerHTML = sorted.map(([cat, amount]) => {
                const percentage = (amount / total * 100).toFixed(1);
                const color = categoryColors[cat] || '#6b7280';
                
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 500;">${cat}</span>
                            <span style="color: ${color}; font-weight: 600;">${SmartCart.formatCurrency(amount)} (${percentage}%)</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${color}; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show top spending items
        function showTopItems(items) {
            const container = document.getElementById('top-items');
            
            if (items.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No data available</p>';
                return;
            }

            const sorted = [...items].sort((a, b) => parseFloat(b.price || 0) - parseFloat(a.price || 0)).slice(0, 5);

            container.innerHTML = sorted.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-100); border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.25rem; font-weight: bold; color: var(--text-secondary);">#${index + 1}</span>
                        <div>
                            <div style="font-weight: 500;">${item.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.category || 'Other'}</div>
                        </div>
                    </div>
                    <div style="font-weight: 600; color: var(--primary);">${SmartCart.formatCurrency(item.price)}</div>
                </div>
            `).join('');
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            document.querySelector('.nav-links').classList.toggle('show');
        }
    </script>
</body>
</html>